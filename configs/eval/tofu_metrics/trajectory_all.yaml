# @package eval.tofu_trajectory.metrics.trajectory_all
# Single-pass: one trajectory_metrics run with all 7 sub-metrics (same R, one sampler pass).
# metric_display_names maps each sub-metric to the log/summary key (trajectory_*).

defaults:
  - .@pre_compute.mia_min_k: mia_min_k
  - ../../data/datasets@datasets: TOFU_MIA
  - ../../collator@collators: DataCollatorForSupervisedDatasetwithIndex

reference_logs:
  retain_model_logs:
    path: ${eval.tofu_trajectory.retain_logs_path}
    include:
      mia_min_k:
        access_key: retain
      forget_truth_ratio:
        access_key: retain
      # For trajectory_model_utility (hm_aggregate): retain run must produce these keys
      retain_Q_A_Prob:
        access_key: retain_Q_A_Prob
      retain_Q_A_ROUGE:
        access_key: retain_Q_A_ROUGE
      retain_Truth_Ratio:
        access_key: retain_Truth_Ratio

pre_compute:
  mia_min_k:
    access_key: forget

handler: trajectory_metrics
batch_size: 1
# Order must match metric_display_names below.
metrics:
  probability: {}
  rouge:
    rouge_type: rougeL_recall
  extraction_strength: {}
  truth_ratio:
    aggregator: closer_to_1_better
    pre_compute:
      correct:
        handler: probability
        access_key: correct
        labels_field: labels_correct
      wrong:
        handler: probability
        access_key: wrong
        labels_field: labels_wrong
  ks_test:
    pre_compute:
      forget_truth_ratio:
        access_key: forget
        handler: truth_ratio
        aggregator: closer_to_1_better
        pre_compute:
          correct:
            handler: probability
            access_key: correct
            labels_field: labels_correct
          wrong:
            handler: probability
            access_key: wrong
            labels_field: labels_wrong
  hm_aggregate: {}
  privleak:
    ref_value: 0.5
    pre_compute:
      mia_min_k:
        access_key: forget
        k: 0.4  # same as standalone mia_min_k.yaml; top-level default does not merge into this nested block

# Set via CLI (e.g. dllm eval --metrics forget_Q_A_Prob forget_Q_A_ROUGE) to run a subset; null = all.
include_metrics: null

metric_display_names:
  - trajectory_forget_Q_A_Prob
  - trajectory_forget_Q_A_ROUGE
  - trajectory_extraction_strength
  - trajectory_forget_Truth_Ratio
  - trajectory_forget_quality
  - trajectory_model_utility
  - trajectory_privleak

trajectory_config:
  logits_source: sampler
  return_logits: true
  return_fixation_steps: true
  sampler_kwargs:
    steps: 16
    temperature: 0.0
    max_new_tokens: 32
    # Tokens between trajectory captures; larger = fewer logits stored, less memory.
    trajectory_sample_interval: 8

datasets:
  TOFU_QA_forget:
    access_key: forget
    args:
      hf_args:
        name: ${eval.tofu_trajectory.forget_split}_perturbed
        split: train
        path: locuslab/TOFU
      question_key: ${eval.tofu_trajectory.question_key}
      answer_key: answer
      max_length: 512
      predict_with_generate: true
  TOFU_QA_holdout:
    access_key: holdout
    args:
      hf_args:
        name: ${eval.tofu_trajectory.holdout_split}
        split: train
        path: locuslab/TOFU
      question_key: ${eval.tofu_trajectory.question_key}
      answer_key: answer
      max_length: 512

collators:
  DataCollatorForSupervisedDataset:
    args:
      padding_side: left

generation_args:
  max_new_tokens: 32
