# @package _global_.eval.metrics.trajectory_metrics
# Trajectory-based metrics for dLLM evaluation
# Computes metrics at each diffusion step across three trajectory types
# Note: Using _global_ to allow this metric to work with any eval config (muse, trajectory_test, etc.)

defaults:
  - ../../data/datasets@datasets: MUSE_forget_knowmem
  - ../../collator@collators: DataCollatorForSupervisedDatasetwithIndex

handler: trajectory_metrics
batch_size: 1  # Start with 1 for testing (trajectory metrics can be memory-intensive)
metrics:
  - probability  # Logit-based metric
  - rouge  # Text-based metric
trajectory_config:
  logits_source: sampler
  return_logits: true
  return_fixation_steps: true
  sampler_kwargs:
    steps: 16
    temperature: 0.0
    max_new_tokens: 32
# path uses ${data_split}; data_split set at root by experiment/CLI
# split override via eval.metrics.trajectory_metrics.datasets.MUSE_forget_knowmem.args.hf_args.split
datasets:
  MUSE_forget_knowmem:
    args:
      hf_args:
        path: muse-bench/MUSE-${data_split}
        name: knowmem
        split: "forget_qa[:5]"  # Override via CLI/config
      few_shot_dataset_hf_args:
        path: muse-bench/MUSE-${data_split}
        name: knowmem
        split: "forget_qa_icl"
      predict_with_generate: True
collators:
  DataCollatorForSupervisedDataset:
    args:
      padding_side: left  # For generation
